<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Monitoring Tinggi Muka Air (TMA)</title>

<style>
body {
  margin:0;
  font-family: Arial, Helvetica, sans-serif;
  background:#f2f4f6;
  color:#222;
}

.header {
  background:#1B365D;
  color:#fff;
  padding:22px 32px;
  display:grid;
  grid-template-columns:1fr 2fr 1fr;
  align-items:center;
}

.header-center {text-align:center;}
.header-center h1 {margin:0;font-size:34px;font-weight:700;}
.sub {margin-top:6px;font-size:18px;}

.container {padding:20px;}

.grid {
  display:grid;
  grid-template-columns:1.2fr 1fr 1fr;
  gap:16px;
}

.card {
  background:#fff;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,.12);
}

.card h2 {
  margin:0;
  padding:12px 16px;
  background:#1B365D;
  color:#fff;
  font-size:18px;
}

table {width:100%;border-collapse:collapse;}
th,td {padding:10px;border-bottom:1px solid #e0e0e0;font-size:14px;}
th {background:#fafafa;}

.bold {font-weight:700;}
.nowrap {white-space:nowrap;}

.tren-naik::before {content:"â–² ";color:#d32f2f;font-weight:bold;}
.tren-turun::before {content:"â–¼ ";color:#000;font-weight:bold;}

.tma-waktu {
  font-size:11.5px;
  color:#555;
}
td.tma-col, th.tma-col {
  white-space: nowrap;
  min-width: 240px;
}

/* ðŸ”´ highlight seluruh baris jika naik */
.tr-naik td {
  background:#fdeaea;
}

td[rowspan] {vertical-align:middle;}

.pda-danger {background:#ff2d2d;color:#fff;padding:12px;font-weight:bold;}
.pda-alert {background:#FFAC1C;padding:12px;font-weight:bold;}
.pda-was {background:#FFEA00;padding:12px;font-weight:bold;}

@media(max-width:900px){
  .grid {grid-template-columns:1fr;}
}
.header-side {
  display: flex;
  align-items: center;
  gap: 12px;
}

.header-right {
  justify-content: flex-end;
}

.logo-left {
  height: 90px;
}

.logo-right {
  height: 48px;
}

.right-text {
  font-size: 13px;
  line-height: 1.2;
}
/* ===== PDA TABLE ALIGNMENT ===== */
.pda-table {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
}

.pda-table td {
  padding: 8px 10px;
  border-bottom: 1px solid #e0e0e0;
  font-size: 14px;
}

.pda-table td:first-child {
  width: 70%;
  text-align: left;
}

.pda-table td:last-child {
  width: 30%;
  text-align: right;
  white-space: nowrap;
  font-weight: 600;
}


</style>
</head>

<body>

<div id="captureArea">

<!-- ================= HEADER ================= -->
<div class="header">
  <!-- LOGO KIRI -->
  <div class="header-side">
    <img 
      src="https://ayucahyani96.github.io/dashboardTMA/IKN_Nusantara-10.png"
      class="logo-left"
      alt="Logo IKN"
    >
  </div>

  <!-- JUDUL -->
  <div class="header-center">
    <h1 id="judul">Monitoring Tinggi Muka Air (TMA)</h1>
    <div class="sub" id="waktu"></div>
  </div>

  <!-- LOGO KANAN -->
  <div class="header-side header-right">
    <img 
      src="https://ayucahyani96.github.io/dashboardTMA/logo_thd.png"
      class="logo-right"
      alt="Transformasi Hijau Digital"
    >
    <div class="right-text">
      Transformasi<br>Hijau dan Digital
    </div>
  </div>
</div>


<div class="container">

<div class="grid">

<!-- ================= TMA ================= -->
<div class="card">
  <h2>Kondisi TMA</h2>
  <table id="tmaTable"></table>
</div>

<!-- ================= PDA ================= -->
<div class="card">
  <h2>Status PDA BWS</h2>

  <div id="pdaBahaya" class="pda-danger"></div>
  <table id="pdaBahayaTable"></table>

  <div id="pdaSiaga" class="pda-alert"></div>
  <table id="pdaSiagaTable"></table>

  <div id="pdaWaspada" class="pda-was"></div>
  <table id="pdaWaspadaTable"></table>
</div>

<!-- ================= TINDAK LANJUT ================= -->
<div class="card">
  <h2>Tindak Lanjut</h2>
  <ol id="tindakList"></ol>
</div>

</div>

<!-- ================= GRAFIK ================= -->
<div class="container">
  <div class="card">
    <h2>Tren Grafik</h2>
    <div style="padding:16px;text-align:center">Grafik belum tersedia</div>
  </div>
</div>

</div>
</div>
<script>
const API_URL="https://script.google.com/macros/s/AKfycbwR6Nc4_q-cB5VVZf-tycqUBHaD_e6wOUcJMpkIT9tec401B9-lAmV7c9fViX9mq1pd7g/exec";

// ===== pasangan TMA =====
function getPasangan(){
  const h=new Date().getHours();
  if(h<13) return {a:"tma20",b:"tma8"};
  if(h<20) return {a:"tma8",b:"tma13"};
  return {a:"tma13",b:"tma20"};
}

const jamLabel={tma8:"08.00",tma13:"13.00",tma20:"20.00"};

function fmtTanggalTMA(baseDate, jamKey) {
  const d = new Date(baseDate);
  const nowHour = new Date().getHours();

  // Jika pagi (<13) dan jam TMA adalah 20.00 â†’ pakai H-1
  if (nowHour < 13 && jamKey === "tma20") {
    d.setDate(d.getDate() - 1);
  }

  const jam = jamLabel[jamKey];

  return `${String(d.getDate()).padStart(2,"0")}/${
    String(d.getMonth()+1).padStart(2,"0")
  }/${d.getFullYear()} ${jam} WITA`;
}


function loadData(data){
  document.getElementById("judul").innerText=data.meta.judul;
  document.getElementById("waktu").innerText=data.meta.tanggal;

  const p=getPasangan();
 // ðŸ”¹ SORTING MONITORING (NAIK â†’ TURUN â†’ STABIL)
  data.new_tma.sort((a, b) => {
    const diffA = (a[p.b] ?? 0) - (a[p.a] ?? 0);
    const diffB = (b[p.b] ?? 0) - (b[p.a] ?? 0);

    // NAIK dulu
    if (diffA > 0 && diffB <= 0) return -1;
    if (diffA <= 0 && diffB > 0) return 1;

    // TURUN setelah naik
    if (diffA < 0 && diffB === 0) return -1;
    if (diffA === 0 && diffB < 0) return 1;

    // SESAMA KATEGORI â†’ BESARAN
    return Math.abs(diffB) - Math.abs(diffA);
  });
  let html=`
  <tr>
  <th class="nowrap">Lokasi</th>
  <th class="tma-col">TMA</th>
  <th class="nowrap">Perubahan</th>
  <th class="nowrap">Penyebab</th>
</tr>`;

  data.new_tma.forEach(r=>{
    const a=r[p.a],b=r[p.b];
    let diff=b-a;
    let cls="",txt="-";

    if(diff>0){cls="tr-naik";txt=`<span class="tren-naik"></span>${diff.toFixed(2)} m`;}
    else if(diff<0){txt=`<span class="tren-turun"></span>${Math.abs(diff).toFixed(2)} m`;}
    else txt="0.00 m";

    html+=`
    <tr class="${cls}">
      <td rowspan="2" class="bold">${r.lokasi}</td>
      <td>${a} m <span class="tma-waktu">(${fmtTanggalTMA(data.meta.tanggal, p.a)})</span></td>
      <td rowspan="2">${txt}</td>
      <td rowspan="2">${r.penyebab||"-"}</td>
    </tr>
    <tr class="${cls}">
      <td>${b} m <span class="tma-waktu">(${fmtTanggalTMA(data.meta.tanggal, p.b)})</span></td>
    </tr>`;
  });


  document.getElementById("tmaTable").innerHTML=html;

  renderPDA("Bahaya",data.pda.filter(p=>p.nama==="Bahaya"));
  renderPDA("Siaga",data.pda.filter(p=>p.nama==="Siaga"));
  renderPDA("Waspada",data.pda.filter(p=>p.nama==="Waspada"));

  document.getElementById("tindakList").innerHTML=
    data.tindak_lanjut.map(t=>`<li>${t.isi}</li>`).join("");
	
	// ================= GRAFIK TREN =================
const g = document.getElementById("grafikContainer");

if (!data.grafik_tren || data.grafik_tren.length === 0) {
  g.innerHTML = `<div style="text-align:center;color:#777">Grafik belum tersedia</div>`;
} else {
  g.innerHTML = data.grafik_tren
    .slice(0, 3) // tampilkan max 3 grafik terbaru
    .map(img => `
      <div style="margin-bottom:16px;text-align:center">
        <img 
          src="${img.url}" 
          alt="${img.name}"
          style="max-width:100%;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.15)"
        >
        <div style="font-size:12px;color:#555;margin-top:6px">
          ${img.name}
        </div>
      </div>
    `)
    .join("");
}

}

function renderPDA(type, arr) {
  const l = document.getElementById("pda" + type);
  const t = document.getElementById("pda" + type + "Table");

  if (arr.length === 0) {
    l.style.display = "none";
    t.style.display = "none";
    return;
  }

  l.innerText = arr.length + " PDA " + type;
  t.className = "pda-table";

  t.innerHTML = arr
    .map(
      p => `
      <tr>
        <td>${p.tinggi}</td>
        <td>${p.status} m</td>
      </tr>
    `
    )
    .join("");
}

// JSONP
const s=document.createElement("script");
s.src=API_URL+"?callback=loadData";
document.body.appendChild(s);

// ===== auto reload jam 08,13,20 =====
(function(){
  const now = new Date();

  // target update: 08:15, 13:15, 20:15
  const target = [
    { h: 8,  m: 15 },
    { h: 13, m: 15 },
    { h: 20, m: 15 }
  ];

  let next = null;

  for (let t of target) {
    const d = new Date();
    d.setHours(t.h, t.m, 0, 0);
    if (d > now) {
      next = d;
      break;
    }
  }

  // kalau hari ini sudah lewat semua â†’ besok 08:15
  if (!next) {
    next = new Date();
    next.setDate(next.getDate() + 1);
    next.setHours(8, 15, 0, 0);
  }

  setTimeout(() => location.reload(), next - now + 2000);
})();
</script>

</body>
</html>
